import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { 
    Save, Lock, FileText, ChevronDown, ChevronUp, Plus, ClipboardList, 
    Sparkles, ArrowLeft, Zap, Search, X, Printer, History, UserCircle,
    Activity, CheckSquare, Square
} from 'lucide-react';
import Toast from '../components/ui/Toast';
import { OrderModal, PrescriptionModal, ReferralModal } from '../components/ActionModals';
import VisitPrint from '../components/VisitPrint';
import PatientHistoryPanel from '../components/PatientHistoryPanel';
import PatientHub from '../components/PatientHub';
import { visitsAPI, codesAPI, patientsAPI } from '../services/api';
import { format } from 'date-fns';
import { hpiDotPhrases } from '../data/hpiDotPhrases';

// Collapsible Section Component
const Section = ({ title, children, defaultOpen = true }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);
    return (
        <div className="border border-neutral-200 rounded-lg bg-white shadow-sm mb-4 overflow-hidden">
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="w-full px-4 py-2 bg-neutral-50 border-b border-neutral-200 flex items-center justify-between hover:bg-neutral-100 transition-colors"
            >
                <h3 className="font-semibold text-neutral-900">{title}</h3>
                {isOpen ? <ChevronUp className="w-4 h-4 text-neutral-500" /> : <ChevronDown className="w-4 h-4 text-neutral-500" />}
            </button>
            {isOpen && <div className="p-4">{children}</div>}
        </div>
    );
};

// Plan Display Component
const PlanDisplay = ({ plan }) => {
    if (!plan) return null;
    const lines = plan.split('\n');
    const formattedLines = [];
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) {
            formattedLines.push(<br key={i} />);
            continue;
        }
        if (line.startsWith('**__') && line.endsWith('__**')) {
            const diagnosis = line.replace(/^\*\*__/, '').replace(/__\*\*$/, '');
            formattedLines.push(
                <div key={i} className="font-bold underline text-ink-900 mb-2 mt-3 first:mt-0">
                    {diagnosis}
                </div>
            );
        } else if (line.startsWith('  - ')) {
            const orderText = line.substring(4);
            formattedLines.push(
                <div key={i} className="ml-4 text-ink-700 mb-1">
                    • {orderText}
                </div>
            );
        } else {
            formattedLines.push(
                <div key={i} className="text-ink-700 mb-1">
                    {line}
                </div>
            );
        }
    }
    return <div className="whitespace-pre-wrap">{formattedLines}</div>;
};

const VisitNote = () => {
    const { id, visitId: urlVisitId } = useParams();
    const navigate = useNavigate();
    const [currentVisitId, setCurrentVisitId] = useState(urlVisitId);
    const [isSigned, setIsSigned] = useState(false);
    const [visitData, setVisitData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [lastSaved, setLastSaved] = useState(null);
    const [toast, setToast] = useState(null);
    const [showOrderModal, setShowOrderModal] = useState(false);
    const [showPrescriptionModal, setShowPrescriptionModal] = useState(false);
    const [showReferralModal, setShowReferralModal] = useState(false);
    const [showPrintModal, setShowPrintModal] = useState(false);
    const [showHistoryPanel, setShowHistoryPanel] = useState(false);
    const [showPatientHub, setShowPatientHub] = useState(false);
    // Note sections
    const [noteData, setNoteData] = useState({
        chiefComplaint: '',
        hpi: '',
        ros: {
            constitutional: false,
            eyes: false,
            ent: false,
            cardiovascular: false,
            respiratory: false,
            gastrointestinal: false,
            genitourinary: false,
            musculoskeletal: false,
            neurological: false,
            skin: false
        },
        rosNotes: '',
        pe: {
            general: false,
            headNeck: false,
            eyes: false,
            ent: false,
            cardiovascular: false,
            respiratory: false,
            abdomen: false,
            extremities: false,
            neurological: false,
            skin: false
        },
        peNotes: '',
        assessment: '',
        plan: ''
    });
    // Vitals
    const [vitals, setVitals] = useState({
        systolic: '',
        diastolic: '',
        bp: '',
        bpReadings: [], // Array of {systolic, diastolic, bp} objects for repeated readings
        temp: '',
        pulse: '',
        resp: '',
        o2sat: '',
        weight: '',
        height: '',
        bmi: '',
        weightUnit: 'lbs',
        heightUnit: 'in'
    });
    // Previous visit weight for comparison
    const [previousWeight, setPreviousWeight] = useState(null);
    const [previousWeightUnit, setPreviousWeightUnit] = useState('lbs');
    // Dot phrases
    const [showDotPhraseModal, setShowDotPhraseModal] = useState(false);
    const [dotPhraseSearch, setDotPhraseSearch] = useState('');
    const [activeTextArea, setActiveTextArea] = useState(null);
    const [hpiDotPhraseSearch, setHpiDotPhraseSearch] = useState('');
    const [showHpiDotPhraseResults, setShowHpiDotPhraseResults] = useState(false);
    // ICD-10 search
    const [showIcd10Search, setShowIcd10Search] = useState(false);
    const [icd10Search, setIcd10Search] = useState('');
    const [icd10Results, setIcd10Results] = useState([]);
    const [icd10AddToProblem, setIcd10AddToProblem] = useState(false);
    // AI Summary
    const [aiSummary, setAiSummary] = useState('');
    const [generatingSummary, setGeneratingSummary] = useState(false);
    // Refs for textareas
    const hpiRef = useRef(null);
    const assessmentRef = useRef(null);
    const planRef = useRef(null);
    // Refs for vitals inputs
    const systolicRef = useRef(null);
    const diastolicRef = useRef(null);
    const tempRef = useRef(null);
    const pulseRef = useRef(null);
    const respRef = useRef(null);
    const o2satRef = useRef(null);
    const weightRef = useRef(null);
    const heightRef = useRef(null);
    // Autocomplete state
    const [autocompleteState, setAutocompleteState] = useState({
        show: false,
        suggestions: [],
        position: { top: 0, left: 0 },
        selectedIndex: 0
    });
    const rosFindings = {
        constitutional: 'No fever, chills, or fatigue. No weight loss or night sweats. Appetite normal.',
        eyes: 'No vision changes, eye pain, or discharge. No double vision or light sensitivity.',
        ent: 'No hearing loss, ear pain, or tinnitus. No nasal congestion, discharge, or sore throat.',
        cardiovascular: 'No chest pain, palpitations, or shortness of breath. No orthopnea or PND.',
        respiratory: 'No cough, wheezing, or difficulty breathing. No hemoptysis or sputum production.',
        gastrointestinal: 'No nausea, vomiting, or diarrhea. No constipation, abdominal pain, or blood in stool.',
        genitourinary: 'No dysuria, frequency, urgency, or hematuria. No incontinence or retention.',
        musculoskeletal: 'No joint pain, swelling, or stiffness. No muscle weakness or limitations in mobility.',
        neurological: 'No headaches, dizziness, or seizures. No changes in mental status, memory, or coordination.',
        skin: 'No rashes, lesions, or changes in moles. No itching, bruising, or hair loss.'
    };

    const peFindings = {
        general: 'Well-appearing, alert, and in no acute distress. Good color and hydration.',
        headNeck: 'Normocephalic, atraumatic. No lymphadenopathy or masses. Neck supple with full range of motion.',
        eyes: 'PERRLA, EOMI. No conjunctival injection or discharge. Visual fields full.',
        ent: 'TMs clear bilaterally. Oropharynx clear, no erythema or exudate. Nasal mucosa pink and moist.',
        cardiovascular: 'Regular rate and rhythm, S1 and S2 normal. No murmurs, rubs, or gallops. Pulses strong and symmetric.',
        respiratory: 'Clear to auscultation bilaterally. No wheezes, rales, or rhonchi. Good air movement.',
        abdomen: 'Soft, non-tender, non-distended. No masses or organomegaly. Bowel sounds active.',
        extremities: 'No edema, cyanosis, or clubbing. Full range of motion. Pulses intact. No deformities.',
        neurological: 'Alert and oriented x3. Cranial nerves II-XII intact. Strength 5/5 throughout. Sensation intact.',
        skin: 'No rashes, lesions, or abnormalities. Good turgor. No jaundice or pallor.'
    };


    const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
    };

    // Find or create visit on mount
    useEffect(() => {
        if (urlVisitId === 'new' && id) {
            setLoading(true);
            visitsAPI.findOrCreate(id, 'Office Visit')
                .then(response => {
                    const visit = response.data;
                    setCurrentVisitId(visit.id);
                    setVisitData(visit);
                    window.history.replaceState({}, '', `/patient/${id}/visit/${visit.id}`);
                    setLoading(false);
                })
                .catch(error => {
                    console.error('Error finding or creating visit:', error);
                    showToast('Could not create visit. Please try again.', 'error');
                    setLoading(false);
                });
        } else if (urlVisitId && urlVisitId !== 'new') {
            setLoading(true);
            visitsAPI.get(urlVisitId)
                .then(response => {
                    const visit = response.data;
                    console.log('Loaded visit:', visit.id, 'note_draft exists:', !!visit.note_draft, 'note_draft length:', visit.note_draft?.length || 0);
                    setVisitData(visit);
                    setCurrentVisitId(visit.id);
                    setIsSigned(visit.locked || !!visit.note_signed_by);
                    if (visit.vitals) {
                        const v = typeof visit.vitals === 'string' ? JSON.parse(visit.vitals) : visit.vitals;
                        setVitals({
                            systolic: v.systolic || '',
                            diastolic: v.diastolic || '',
                            bp: v.bp || (v.systolic && v.diastolic ? `${v.systolic}/${v.diastolic}` : ''),
                            bpReadings: v.bpReadings || [],
                            temp: v.temp || '',
                            pulse: v.pulse || '',
                            resp: v.resp || '',
                            o2sat: v.o2sat || '',
                            weight: v.weight || '',
                            height: v.height || '',
                            bmi: v.bmi || '',
                            weightUnit: v.weightUnit || 'lbs',
                            heightUnit: v.heightUnit || 'in'
                        });
                    }
                    // Always try to parse note_draft, even if it's an empty string
                    // This ensures we load any existing content
                    if (visit.note_draft !== undefined && visit.note_draft !== null && visit.note_draft.trim() !== '') {
                        console.log('Loading note_draft:', visit.note_draft.substring(0, 200), 'Length:', visit.note_draft.length);
                        const parsed = parseNoteText(visit.note_draft);
                        console.log('Parsed note sections:', {
                            hpi: parsed.hpi?.substring(0, 50),
                            assessment: parsed.assessment?.substring(0, 50),
                            plan: parsed.plan?.substring(0, 50),
                            rosNotes: parsed.rosNotes?.substring(0, 50),
                            peNotes: parsed.peNotes?.substring(0, 50)
                        });
                        // Update note data with parsed content - only update if we found content
                        setNoteData(prev => ({
                            ...prev,
                            hpi: parsed.hpi ? parsed.hpi : prev.hpi,
                            assessment: parsed.assessment ? parsed.assessment : prev.assessment,
                            plan: parsed.plan ? parsed.plan : prev.plan,
                            rosNotes: parsed.rosNotes ? parsed.rosNotes : prev.rosNotes,
                            peNotes: parsed.peNotes ? parsed.peNotes : prev.peNotes
                        }));
                        // Generate AI summary for signed notes
                        if ((visit.locked || visit.note_signed_by) && parsed) {
                            setTimeout(() => generateAISummary(parsed, visit), 100);
                        }
                    } else {
                        console.log('No note_draft field found for visit:', visit.id);
                    }
                    setLoading(false);
                })
                .catch(error => {
                    console.error('Error loading visit:', error);
                    showToast('Could not load visit.', 'error');
                    setLoading(false);
                });
        } else {
            setLoading(false);
        }


    const parseNoteText = (text) => {
        if (!text || !text.trim()) return { hpi: '', assessment: '', plan: '', rosNotes: '', peNotes: '' };
        // Try to parse structured format first
        const hpiMatch = text.match(/(?:HPI|History of Present Illness):\s*(.+?)(?:\n\n|\n(?:ROS|Review|PE|Physical|Assessment|Plan):)/is);
        const rosMatch = text.match(/(?:ROS|Review of Systems):\s*(.+?)(?:\n\n|\n(?:PE|Physical|Assessment|Plan):)/is);
        const peMatch = text.match(/(?:PE|Physical Exam):\s*(.+?)(?:\n\n|\n(?:Assessment|Plan):)/is);
        const assessmentMatch = text.match(/(?:Assessment|A):\s*(.+?)(?:\n\n|\n(?:Plan|P):)/is);
        const planMatch = text.match(/(?:Plan|P):\s*(.+?)(?:\n\n|$)/is);
        // If we found structured sections, return them
        if (hpiMatch || assessmentMatch || planMatch || rosMatch || peMatch) {
            return {
                hpi: hpiMatch ? hpiMatch[1].trim() : '',
                rosNotes: rosMatch ? rosMatch[1].trim() : '',
                peNotes: peMatch ? peMatch[1].trim() : '',
                assessment: assessmentMatch ? assessmentMatch[1].trim() : '',
                plan: planMatch ? planMatch[1].trim() : ''
            };
        }
        // If no structured format found, check if it's just plain text
        // If the text doesn't have section headers, treat the whole thing as HPI
        // This handles cases where notes were saved without proper formatting
        const trimmedText = text.trim();
        if (trimmedText && !trimmedText.match(/^(HPI|History|ROS|Review|PE|Physical|Assessment|Plan|A|P):/i)) {
            console.log('Note appears to be unstructured, treating as HPI');
            return {
                hpi: trimmedText,
                rosNotes: '',
                peNotes: '',
                assessment: '',
                plan: ''
            };
        }
        return {
            hpi: hpiMatch ? hpiMatch[1].trim() : '',
            rosNotes: rosMatch ? rosMatch[1].trim() : '',
            peNotes: peMatch ? peMatch[1].trim() : '',
            assessment: assessmentMatch ? assessmentMatch[1].trim() : '',
            plan: planMatch ? planMatch[1].trim() : ''
        };
    };

    const combineNoteSections = () => {
        const sections = [];
        if (noteData.hpi) sections.push(`HPI: ${noteData.hpi}`);
        // ROS
        const rosSystems = Object.entries(noteData.ros)
            .filter(([_, checked]) => checked)
            .map(([system]) => system);
        if (rosSystems.length > 0 || noteData.rosNotes) {
            const rosText = rosSystems.length > 0 
                ? `Review of Systems: ${rosSystems.join(', ')}. ${noteData.rosNotes || ''}`
                : `Review of Systems: ${noteData.rosNotes}`;
            sections.push(rosText);
        }
        // PE
        const peSystems = Object.entries(noteData.pe)
            .filter(([_, checked]) => checked)
            .map(([system]) => system);
        if (peSystems.length > 0 || noteData.peNotes) {
            const peText = peSystems.length > 0
                ? `Physical Exam: ${peSystems.join(', ')}. ${noteData.peNotes || ''}`
                : `Physical Exam: ${noteData.peNotes}`;
            sections.push(peText);
        }
        if (noteData.assessment) sections.push(`Assessment: ${noteData.assessment}`);
        if (noteData.plan) sections.push(`Plan: ${noteData.plan}`);
        return sections.join('\n\n');
    };

    const handleSave = async () => {
        if (isSigned || isSaving) return;
        setIsSaving(true);
        try {
            const noteDraft = combineNoteSections();
            let visitId = currentVisitId || urlVisitId;
            console.log('Saving note - visitId:', visitId, 'noteDraft length:', noteDraft.length);
            // If visitId is 'new', try to find or create the visit first
            if (!visitId || visitId === 'new') {
                if (!id) {
                    showToast('Patient ID is missing', 'error');
                    setIsSaving(false);
                    return;
                }
                try {
                    console.log('Creating/finding visit for patient:', id);
                    const response = await visitsAPI.findOrCreate(id, 'Office Visit');
                    visitId = response.data.id;
                    setCurrentVisitId(visitId);
                    setVisitData(response.data);
                    window.history.replaceState({}, '', `/patient/${id}/visit/${visitId}`);
                    console.log('Visit created/found:', visitId);
                } catch (error) {
                    console.error('Error creating visit:', error);
                    console.error('Error response:', error.response?.data);
                    showToast('Failed to create visit: ' + (error.response?.data?.error || error.message), 'error');
                    setIsSaving(false);
                    return;
                }
            }
            if (visitId) {
                const vitalsToSave = {
                    systolic: vitals.systolic || null,
                    diastolic: vitals.diastolic || null,
                    bp: vitals.bp || (vitals.systolic && vitals.diastolic ? `${vitals.systolic}/${vitals.diastolic}` : null),
                    temp: vitals.temp || null,
                    pulse: vitals.pulse || null,
                    resp: vitals.resp || null,
                    o2sat: vitals.o2sat || null,
                    weight: vitals.weight || null,
                    height: vitals.height || null,
                    bmi: vitals.bmi || null,
                    weightUnit: vitals.weightUnit || 'lbs',
                    heightUnit: vitals.heightUnit || 'in'
                };
                console.log('Updating visit:', visitId);
                console.log('Note draft length:', noteDraft.length, 'Content preview:', noteDraft.substring(0, 100));
                console.log('Vitals to save:', vitalsToSave);
                const updateData = {
                    noteDraft: noteDraft || '', // Always send noteDraft, even if empty
                    vitals: vitalsToSave 
                };
                console.log('Sending update data:', { ...updateData, noteDraft: updateData.noteDraft.substring(0, 50) + '...' });
                                const response = await visitsAPI.update(visitId, updateData);
                console.log('Save response:', response.data);
                // Reload visit data to ensure we have the latest note_draft
                try {
                    const reloadResponse = await visitsAPI.get(visitId);
                    const reloadedVisit = reloadResponse.data;
                    setVisitData(reloadedVisit);
                    // Reload note content if note_draft exists
                    if (reloadedVisit.note_draft && reloadedVisit.note_draft.trim() !== '') {
                        const parsed = parseNoteText(reloadedVisit.note_draft);
                        setNoteData(prev => ({
                            ...prev,
                            hpi: parsed.hpi ? parsed.hpi : prev.hpi,
                            assessment: parsed.assessment ? parsed.assessment : prev.assessment,
                            plan: parsed.plan ? parsed.plan : prev.plan,
                            rosNotes: parsed.rosNotes ? parsed.rosNotes : prev.rosNotes,
                            peNotes: parsed.peNotes ? parsed.peNotes : prev.peNotes
                        }));
                    }
                } catch (reloadError) {
                    console.error('Error reloading visit after save:', reloadError);
                }
                setLastSaved(new Date());
                showToast('Draft saved successfully', 'success');
            } else {
                showToast('Visit ID is missing', 'error');
            }
        } catch (error) {
            console.error('Error saving:', error);
            console.error('Error response:', error.response?.data);
            console.error('Error status:', error.response?.status);
            showToast('Failed to save: ' + (error.response?.data?.error || error.message || 'Unknown error'), 'error');
        } finally {
            setIsSaving(false);
        }
    };

    const handleSign = async () => {
        if (isSigned || isSaving) return;
        setIsSaving(true);
        try {
            const noteDraft = combineNoteSections();
            let visitId = currentVisitId || urlVisitId;
            // If visitId is 'new', try to find or create the visit first
            if (!visitId || visitId === 'new') {
                if (!id) {
                    showToast('Patient ID is missing', 'error');
                    setIsSaving(false);
                    return;
                }
                try {
                    const response = await visitsAPI.findOrCreate(id, 'Office Visit');
                    visitId = response.data.id;
                    setCurrentVisitId(visitId);
                    window.history.replaceState({}, '', `/patient/${id}/visit/${visitId}`);
                } catch (error) {
                    console.error('Error creating visit:', error);
                    showToast('Failed to create visit. Please try again.', 'error');
                    setIsSaving(false);
                    return;
                }
            }
            if (visitId) {
                await visitsAPI.sign(visitId, noteDraft);
                setIsSigned(true);
                showToast('Note signed successfully', 'success');
                const response = await visitsAPI.get(visitId);
                setVisitData(response.data);
            } else {
                showToast('Visit ID is missing', 'error');
            }
        } catch (error) {
            console.error('Error signing:', error);
            showToast('Failed to sign note: ' + (error.response?.data?.error || error.message || 'Unknown error'), 'error');
        } finally {
            setIsSaving(false);
        }
    };

    // Dot phrase handling
    const handleDotPhrase = (phrase) => {
        const template = hpiDotPhrases[phrase];
        if (!template) return;
        const textarea = activeTextArea === 'hpi' ? hpiRef.current :
                        activeTextArea === 'assessment' ? assessmentRef.current :
                        activeTextArea === 'plan' ? planRef.current : null;
        if (textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end);
            // Replace dot phrase with template
            const newText = before.replace(new RegExp(`\\.${phrase.replace('.', '')}\\s*$`), '') + template + after;
            if (activeTextArea === 'hpi') {
                setNoteData({...noteData, hpi: newText});
            } else if (activeTextArea === 'assessment') {
                setNoteData({...noteData, assessment: newText});
            } else if (activeTextArea === 'plan') {
                setNoteData({...noteData, plan: newText});
            }
            // Focus and set cursor after template
            setTimeout(() => {
                textarea.focus();
                const newPos = start + template.length;
                textarea.setSelectionRange(newPos, newPos);
            }, 0);
        }
        setShowDotPhraseModal(false);
        setDotPhraseSearch('');
        setActiveTextArea(null);
    };

    // F2 key handler for placeholders
    const handleF2Key = useCallback((e, textareaRef, field) => {
        if (e.key === 'F2' && textareaRef.current) {
            e.preventDefault();
            const textarea = textareaRef.current;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            // Find next [] placeholder
            const placeholderRegex = /\[([^\]]+)\]/g;
            let match;
            let found = false;
            while ((match = placeholderRegex.exec(text)) !== null) {
                if (match.index >= cursorPos) {
                    textarea.setSelectionRange(match.index, match.index + match[0].length);
                    found = true;
                    break;
                }
            }
            if (!found) {
                // Search from beginning
                placeholderRegex.lastIndex = 0;
                match = placeholderRegex.exec(text);
                if (match) {
                    textarea.setSelectionRange(match.index, match.index + match[0].length);
                }
            }
        }
    }, []);


    // Dot phrase autocomplete
    const handleDotPhraseAutocomplete = useCallback((value, field, textareaRef) => {
        if (!textareaRef.current) return;
        const textarea = textareaRef.current;
        const cursorPos = textarea.selectionStart;
        const textBeforeCursor = value.substring(0, cursorPos);
        // Find if we're typing a dot phrase (look for . followed by word characters)
        const dotPhraseMatch = textBeforeCursor.match(/\.([a-z0-9_]*)$/i);
        if (dotPhraseMatch) {
            const partialPhrase = dotPhraseMatch[1].toLowerCase();
            const suggestions = Object.keys(hpiDotPhrases)
                .filter(key => key.toLowerCase().startsWith('.' + partialPhrase))
                .slice(0, 8)
                .map(key => ({
                    key,
                    template: hpiDotPhrases[key],
                    display: key
                }));
            if (suggestions.length > 0) {
                // Get cursor position for autocomplete dropdown
                const rect = textarea.getBoundingClientRect();
                const lineHeight = 20; // Approximate line height
                const lines = textBeforeCursor.split('\n');
                const currentLine = lines.length - 1;
                const top = rect.top + (currentLine * lineHeight) + lineHeight;
                setAutocompleteState({
                    show: true,
                    suggestions,
                    position: { top, left: rect.left },
                    selectedIndex: 0,
                    field,
                    textareaRef,
                    matchStart: cursorPos - dotPhraseMatch[0].length,
                    matchEnd: cursorPos
                });
            } else {
                setAutocompleteState(prev => ({ ...prev, show: false }));
            }
        } else {
            setAutocompleteState(prev => ({ ...prev, show: false }));
        }
    }, []);

    // Insert dot phrase from autocomplete
    const insertDotPhrase = useCallback((phrase, autocompleteState) => {
        if (!autocompleteState.textareaRef?.current) return;
        const textarea = autocompleteState.textareaRef.current;
        const template = hpiDotPhrases[phrase];
        if (!template) return;
        const currentValue = textarea.value;
        const before = currentValue.substring(0, autocompleteState.matchStart);
        const after = currentValue.substring(autocompleteState.matchEnd);
        const newValue = before + template + after;
        if (autocompleteState.field === 'hpi') {
            setNoteData(prev => ({ ...prev, hpi: newValue }));
        } else if (autocompleteState.field === 'assessment') {
            setNoteData(prev => ({ ...prev, assessment: newValue }));
        } else if (autocompleteState.field === 'plan') {
            setNoteData(prev => ({ ...prev, plan: newValue }));
        }
        // Set cursor position after inserted text
        setTimeout(() => {
            const newCursorPos = before.length + template.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
        }, 0);
        setAutocompleteState(prev => ({ ...prev, show: false }));
    }, []);


    // Inline dot phrase expansion
    const handleTextChange = (value, field) => {
        // Decode HTML entities
        const decoded = value.replace(/&#x2F;/g, '/').replace(/&#47;/g, '/').replace(/&amp;/g, '&');
        if (field === 'hpi') {
            setNoteData({...noteData, hpi: decoded});
        } else if (field === 'assessment') {
            setNoteData({...noteData, assessment: decoded});
        } else if (field === 'plan') {
            setNoteData({...noteData, plan: decoded});
        }
        // Check for dot phrase expansion
        const dotPhraseMatch = decoded.match(/(^|\s|\n)\.([a-z0-9_]+?)(?=\s|$|\n|\[)/i);
        if (dotPhraseMatch) {
            const phrase = `.${dotPhraseMatch[2]}`;
            if (hpiDotPhrases[phrase]) {
                const before = decoded.substring(0, decoded.length - phrase.length);
                const template = hpiDotPhrases[phrase];
                const newText = before + template;
                if (field === 'hpi') {
                    setNoteData({...noteData, hpi: newText});
                } else if (field === 'assessment') {
                    setNoteData({...noteData, assessment: newText});
                } else if (field === 'plan') {
                    setNoteData({...noteData, plan: newText});
                }
            }
        }
    };

    // ICD-10 search
    useEffect(() => {
        if (icd10Search.trim().length >= 2) {
            const timeout = setTimeout(async () => {
                try {
                    const response = await codesAPI.searchICD10(icd10Search);
                    setIcd10Results(response.data || []);
                } catch (error) {
                    console.error('Error searching ICD-10 codes:', error);
                    setIcd10Results([]);
                }
            }, 300);
            return () => clearTimeout(timeout);
        } else {
            setIcd10Results([]);
        }
    }, [icd10Search]);

    const handleAddICD10 = async (code) => {
        if (icd10AddToProblem) {
            try {
                await patientsAPI.addProblem(id, {
                    problemName: code.description,
                    icd10Code: code.code,
                    status: 'active'
                });
                showToast(`Added ${code.code} to problem list`, 'success');
            } catch (error) {
                console.error('Error adding to problem list:', error);
            }
        }
        const newAssessment = noteData.assessment 
            ? `${noteData.assessment}\n${code.code} - ${code.description}`
            : `${code.code} - ${code.description}`;
        setNoteData({...noteData, assessment: newAssessment});
        setShowIcd10Search(false);
        setIcd10Search('');
    };

    // AI Summary generation
    const generateAISummary = async (parsed, visit) => {
        if (generatingSummary || aiSummary) return;
        setGeneratingSummary(true);
        try {
            // Simple summary generation (can be replaced with actual AI API)
            const summaryParts = [];
            if (parsed.hpi) summaryParts.push(`Chief complaint: ${parsed.hpi.substring(0, 100)}...`);
            if (parsed.assessment) summaryParts.push(`Diagnoses: ${parsed.assessment.substring(0, 100)}...`);
            if (parsed.plan) summaryParts.push(`Plan: ${parsed.plan.substring(0, 100)}...`);
            const summary = summaryParts.join(' ');
            setAiSummary(summary || 'Visit summary will be generated automatically.');
        } catch (error) {
            console.error('Error generating summary:', error);
        } finally {
            setGeneratingSummary(false);
        }
    };

    // Unit conversion helpers
    const convertWeight = (value, fromUnit, toUnit) => {
        if (!value) return '';
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        if (fromUnit === 'lbs' && toUnit === 'kg') {
            return (num / 2.20462).toFixed(1);
        } else if (fromUnit === 'kg' && toUnit === 'lbs') {
            return (num * 2.20462).toFixed(1);
        }
        return value;
    };

    // Parse height in "x'xx"" format to total inches
    const parseFeetInches = (value) => {
        if (!value) return null;
        const str = value.toString().trim();
        // Check if it's in "x'xx"" or "x'xx" format
        const match = str.match(/^(\d+)'(\d+)"?$/);
        if (match) {
            const feet = parseInt(match[1], 10);
            const inches = parseInt(match[2], 10);
            if (feet >= 0 && feet <= 8 && inches >= 0 && inches < 12) {
                return feet * 12 + inches; // Return total inches
            }
        }
        // Try parsing as "x xx" (space separated)
        const spaceMatch = str.match(/^(\d+)\s+(\d+)$/);
        if (spaceMatch) {
            const feet = parseInt(spaceMatch[1], 10);
            const inches = parseInt(spaceMatch[2], 10);
            if (feet >= 0 && feet <= 8 && inches >= 0 && inches < 12) {
                return feet * 12 + inches;
            }
        }
        // If it's a number, assume it's total inches (for backward compatibility)
        const num = parseFloat(str);
        if (!isNaN(num) && num > 0) {
            return num;
        }
        return null;
    };

    // Format total inches to "x'xx"" format
    const formatFeetInches = (totalInches) => {
        if (!totalInches) return '';
        const num = parseFloat(totalInches);
        if (isNaN(num) || num <= 0) return '';
        const feet = Math.floor(num / 12);
        const inches = Math.round(num % 12);
        return `${feet}'${inches}"`;
    };

    // Format user input for feet/inches - only format when apostrophe is present
    const handleFeetInchesInput = (inputValue) => {
        if (!inputValue) return '';
        // Allow free typing - only format if apostrophe is present
        if (inputValue.includes("'")) {
            const parts = inputValue.split("'");
            const feetPart = parts[0] || '';
            const inchesPart = parts[1] || '';
            // Clean feet part - only digits
            const feetDigits = feetPart.replace(/\D/g, '');
            const feet = feetDigits ? Math.min(parseInt(feetDigits, 10) || 0, 8) : '';
            // Clean inches part - only digits, limit to 2 digits max
            const inchesDigits = inchesPart.replace(/\D/g, '').slice(0, 2);
            const inches = inchesDigits ? Math.min(parseInt(inchesDigits, 10) || 0, 11) : '';
            // Format: if both parts exist, format properly; otherwise just return what they typed
            if (feet !== '' && inches !== '') {
                return `${feet}'${inches}"`;
            } else if (feet !== '') {
                return `${feet}'${inchesPart}`;
            } else {
                return inputValue; // Return as-is if no feet entered yet
            }
        }
        // If no apostrophe, allow free typing (just clean non-allowed chars)
        // Allow digits, apostrophe, and quote
        return inputValue.replace(/[^\d'"]/g, '');
    };

    const convertHeight = (value, fromUnit, toUnit) => {
        if (!value || fromUnit === toUnit) return value;
        // Parse feet/inches format if fromUnit is 'ft'
        let totalInches;
        if (fromUnit === 'ft') {
            totalInches = parseFeetInches(value);
            if (totalInches === null) return value;
        } else {
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            if (fromUnit === 'cm') {
                totalInches = num / 2.54;
            } else {
                totalInches = num;
            }
        }
        // Convert from total inches to target unit
        if (toUnit === 'cm') {
            return (totalInches * 2.54).toFixed(1);
        } else if (toUnit === 'ft') {
            return formatFeetInches(totalInches);
        }
        return value;
    };

    const calculateBMI = (weight, weightUnit, height, heightUnit) => {
        let weightKg = weightUnit === 'lbs' ? parseFloat(weight) / 2.20462 : parseFloat(weight);
        let heightM;
        if (heightUnit === 'in') {
            heightM = parseFloat(height) * 0.0254;
        } else {
            // cm
            heightM = parseFloat(height) / 100;
        }
        if (isNaN(weightKg) || isNaN(heightM) || heightM === 0) return '';
        return (weightKg / (heightM * heightM)).toFixed(1);
    };

    // Check for abnormal vital values
    const isAbnormalVital = (type, value) => {
        if (!value || value === '') return false;
        const num = parseFloat(value);
        if (isNaN(num)) return false;
        switch (type) {
            case 'systolic':
                return num < 90 || num > 140;
            case 'diastolic':
                return num < 60 || num > 90;
            case 'temp':
                return num < 97 || num > 99.5;
            case 'pulse':
                return num < 60 || num > 100;
            case 'resp':
                return num < 12 || num > 20;
            case 'o2sat':
                return num < 95;
            case 'bmi':
                return num < 18.5 || num > 25;
            default:
                return false;
        }
    };

    // Get weight change from previous visit
    const getWeightChange = () => {
        if (!vitals.weight || !previousWeight) return null;
        const currentWeight = parseFloat(vitals.weight);
        const prevWeight = parseFloat(previousWeight);
        if (isNaN(currentWeight) || isNaN(prevWeight)) return null;
        // Convert to same unit for comparison
        let currentKg = vitals.weightUnit === 'lbs' ? currentWeight / 2.20462 : currentWeight;
        let prevKg = previousWeightUnit === 'lbs' ? prevWeight / 2.20462 : prevWeight;
        const change = currentKg - prevKg;
        const changeLbs = change * 2.20462;
        return {
            kg: change.toFixed(1),
            lbs: changeLbs.toFixed(1),
            percent: ((change / prevKg) * 100).toFixed(1)
        };
    };

    // Fetch previous visit weight
    useEffect(() => {
        const fetchPreviousWeight = async () => {
            if (!id || !currentVisitId) return;
            try {
                const response = await visitsAPI.getByPatient(id);
                const visits = response.data || [];
                // Find the most recent visit before current one
                const currentVisit = visits.find(v => v.id === currentVisitId);
                if (!currentVisit) return;
                const previousVisits = visits
                    .filter(v => v.id !== currentVisitId && v.vitals)
                    .sort((a, b) => new Date(b.visit_date) - new Date(a.visit_date));
                if (previousVisits.length > 0) {
                    const prevVisit = previousVisits[0];
                    const prevVitals = typeof prevVisit.vitals === 'string' 
                        ? JSON.parse(prevVisit.vitals) 
                        : prevVisit.vitals;
                    if (prevVitals && prevVitals.weight) {
                        setPreviousWeight(prevVitals.weight);
                        setPreviousWeightUnit(prevVitals.weightUnit || 'lbs');
                    }
                }
            } catch (error) {
                console.error('Error fetching previous weight:', error);
            }
        };
        if (currentVisitId && currentVisitId !== 'new') {
            fetchPreviousWeight();
        }
    }, [id, currentVisitId]);

    // Filtered dot phrases for autocomplete
    const filteredDotPhrases = useMemo(() => {
        if (!dotPhraseSearch.trim()) return [];
        const search = dotPhraseSearch.toLowerCase();
        return Object.keys(hpiDotPhrases)
            .filter(key => key.toLowerCase().includes(search))
            .slice(0, 10)
            .map(key => ({
                key,
                template: hpiDotPhrases[key],
                source: 'hpi'
            }));
    }, [dotPhraseSearch]);

    // Filtered HPI dot phrases
    const filteredHpiDotPhrases = useMemo(() => {
        if (!hpiDotPhraseSearch.trim()) return [];
        const search = hpiDotPhraseSearch.toLowerCase();
        return Object.keys(hpiDotPhrases)
            .filter(key => key.toLowerCase().includes(search))
            .slice(0, 20)
            .map(key => ({
                key,
                template: hpiDotPhrases[key]
            }));
    }, [hpiDotPhraseSearch]);

    if (loading) {
        return (
            <div className="min-h-screen bg-neutral-50 flex items-center justify-center">
                <div className="text-center">
                    <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mb-4"></div>
                    <p className="text-neutral-600">Loading visit...</p>
                </div>
            </div>
        );
    }

    const visitDate = visitData?.visit_date ? format(new Date(visitData.visit_date), 'MMM d, yyyy') : format(new Date(), 'MMM d, yyyy');
    const providerName = visitData?.provider_first_name && visitData?.provider_last_name
        ? `${visitData.provider_first_name} ${visitData.provider_last_name}`
        : 'Provider';

    // Read-only view for signed notes
    if (isSigned && visitData) {
        const parsed = parseNoteText(visitData.note_draft || '');
        return (
            <div className="min-h-screen bg-neutral-50 py-8">
                <div className="max-w-5xl mx-auto px-6">
                    <div className="bg-neutral-50 border-2 border-neutral-200 shadow-lg mb-6 p-6">
                        <div className="flex items-center justify-between mb-4 pb-4 border-b-2 border-neutral-300">
                            <div>
                                <h1 className="text-3xl font-serif font-bold text-ink-900 mb-1">Office Visit Note</h1>
                                <p className="text-ink-600 text-sm">{visitDate} • {providerName}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                                <div className="flex items-center space-x-2 text-green-700">
                                    <Lock className="w-4 h-4" />
                                    <span className="text-sm font-medium">Signed</span>
                                </div>
                                <button
                                    onClick={() => setShowPrintModal(true)}
                                    className="p-2 text-ink-600 hover:bg-primary-100 rounded"
                                >
                                    <Printer className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={() => navigate(-1)}
                                    className="p-2 text-ink-600 hover:bg-primary-100 rounded"
                                >
                                    <ArrowLeft className="w-4 h-4" />
                                </button>
                            </div>
                        </div>

                        {/* Read-only content */}
                        {parsed.hpi && (
                            <div className="mb-6 pb-4 border-b border-neutral-200">
                                <h2 className="text-lg font-serif font-bold text-ink-900 mb-3">History of Present Illness</h2>
                                <p className="text-ink-700 whitespace-pre-wrap font-serif">
                                    {parsed.hpi.replace(/&#x2F;/g, '/').replace(/&#47;/g, '/')}
                                </p>
                            </div>
                        )}
                        {parsed.assessment && (
                            <div className="mb-6 pb-4 border-b border-neutral-200">
                                <h2 className="text-lg font-serif font-bold text-ink-900 mb-3">Assessment</h2>
                                <p className="text-ink-700 whitespace-pre-wrap font-serif">
                                    {parsed.assessment.replace(/&#x2F;/g, '/').replace(/&#47;/g, '/')}
                                </p>
                            </div>
                        )}
                        {parsed.plan && (
                            <div className="mb-6">
                                <h2 className="text-lg font-serif font-bold text-ink-900 mb-3">Plan</h2>
                                <PlanDisplay plan={parsed.plan} />
                            </div>
                        )}

                        {/* AI Summary */}
                        {aiSummary && (
                            <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded">
                                <div className="flex items-center space-x-2 mb-2">
                                    <Sparkles className="w-5 h-5 text-blue-700" />
                                    <h3 className="font-bold text-ink-900">AI Visit Summary</h3>
                                </div>
                                <p className="text-sm text-ink-700">{aiSummary}</p>
                            </div>
                        )}
                    </div>
                </div>

                {showPrintModal && (
                    <VisitPrint
                        visitId={currentVisitId || urlVisitId}
                        patientId={id}
                        onClose={() => setShowPrintModal(false)}
                    />
                )}
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-neutral-50 py-8">
            <div className="max-w-5xl mx-auto px-6">
                {/* Master Back Button - Top of page */}
                <div className="mb-4">
                    <button
                        onClick={() => navigate(-1)}
                        className="flex items-center space-x-2 text-neutral-600 hover:text-neutral-900 transition-colors"
                    >
                        <ArrowLeft className="w-4 h-4" />
                        <span className="text-sm font-medium">Back</span>
                    </button>
                </div>

                {/* Header */}
                <div className="bg-white border border-neutral-200 rounded-lg shadow-md mb-6 p-6">
                    <div className="flex items-center justify-between mb-4 pb-4 border-b border-neutral-200">
                        <div>
                            <h1 className="text-3xl font-bold text-neutral-900 mb-1">Office Visit Note</h1>
                            <p className="text-neutral-600 text-sm">{visitDate} • {providerName}</p>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => setShowHistoryPanel(!showHistoryPanel)}
                                className={`p-2 rounded transition-colors ${
                                    showHistoryPanel ? 'bg-primary-200' : 'hover:bg-primary-100'
                                }`}
                                title="Patient History"
                            >
                                <History className="w-4 h-4" />
                            </button>
                            <button
                                onClick={() => setShowPatientHub(!showPatientHub)}
                                className={`p-2 rounded transition-colors ${
                                    showPatientHub ? 'bg-primary-200' : 'hover:bg-primary-100'
                                }`}
                                title="Patient Hub"
                            >
                                <UserCircle className="w-4 h-4" />
                            </button>
                            {!isSigned && (
                                <>
                                    {lastSaved && (
                                        <span className="text-xs text-ink-500 italic">
                                            Saved {lastSaved.toLocaleTimeString()}
                                        </span>
                                    )}
                                    <button
                                        onClick={handleSave}
                                        disabled={isSaving}
                                        className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded shadow-sm flex items-center space-x-2 disabled:opacity-50"
                                    >
                                        <Save className="w-4 h-4" />
                                        <span>{isSaving ? 'Saving...' : 'Save'}</span>
                                    </button>
                                    <button
                                        onClick={handleSign}
                                        className="px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded shadow-sm flex items-center space-x-2"
                                    >
                                        <Lock className="w-4 h-4" />
                                        <span>Sign</span>
                                    </button>
                                </>
                            )}
                            <button
                                onClick={() => setShowPrintModal(true)}
                                className="p-2 text-neutral-600 hover:bg-neutral-100 rounded transition-colors"
                                title="Print"
                            >
                                <Printer className="w-4 h-4" />
                            </button>
                        </div>
                    </div>

                    {/* Vitals */}
                    <Section title="Vital Signs" defaultOpen={true}>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">BP (mmHg)</label>
                                {/* First BP Reading */}
                                <div className="flex items-center gap-1">
                                    <input
                                        ref={systolicRef}
                                        type="number"
                                        placeholder="120"
                                        value={vitals.systolic}
                                        onChange={(e) => {
                                            const sys = e.target.value;
                                            const bp = sys && vitals.diastolic ? `${sys}/${vitals.diastolic}` : '';
                                            setVitals({...vitals, systolic: sys, bp});
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                diastolicRef.current?.focus();
                                            }
                                        }}
                                        disabled={isSigned}
                                        className={`w-16 p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                            isAbnormalVital('systolic', vitals.systolic) ? 'text-red-600 font-bold' : ''
                                        }`}
                                    />
                                    <span className="text-neutral-400 text-xs px-1">/</span>
                                    <input
                                        ref={diastolicRef}
                                        type="number"
                                        placeholder="80"
                                        value={vitals.diastolic}
                                        onChange={(e) => {
                                            const dia = e.target.value;
                                            const bp = vitals.systolic && dia ? `${vitals.systolic}/${dia}` : '';
                                            setVitals({...vitals, diastolic: dia, bp});
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                pulseRef.current?.focus();
                                            }
                                        }}
                                        disabled={isSigned}
                                        className={`w-16 p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                            isAbnormalVital('diastolic', vitals.diastolic) ? 'text-red-600 font-bold' : ''
                                        }`}
                                    />
                                </div>
                                {/* Additional BP Readings */}
                                {vitals.bpReadings && vitals.bpReadings.length > 0 && (
                                    <div className="space-y-0.5">
                                        {vitals.bpReadings.map((reading, index) => (
                                            <div key={index} className="flex items-center gap-1">
                                                <span className={`text-xs ${
                                                    (isAbnormalVital('systolic', reading.systolic) || isAbnormalVital('diastolic', reading.diastolic)) 
                                                        ? 'text-red-600 font-bold' : 'text-neutral-600'
                                                }`}>
                                                    {reading.bp}
                                                </span>
                                                {!isSigned && (
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            const newReadings = vitals.bpReadings.filter((_, i) => i !== index);
                                                            setVitals({...vitals, bpReadings: newReadings});
                                                        }}
                                                        className="text-red-500 hover:text-red-700"
                                                        title="Remove"
                                                    >
                                                        <X className="w-2.5 h-2.5" />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">HR (bpm)</label>
                                <input
                                    ref={pulseRef}
                                    type="number"
                                    placeholder="72"
                                    value={vitals.pulse}
                                    onChange={(e) => setVitals({...vitals, pulse: e.target.value})}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            o2satRef.current?.focus();
                                        }
                                    }}
                                    disabled={isSigned}
                                    className={`w-full p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                        isAbnormalVital('pulse', vitals.pulse) ? 'text-red-600 font-bold' : ''
                                    }`}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">O2 Sat (%)</label>
                                <input
                                    ref={o2satRef}
                                    type="number"
                                    placeholder="98"
                                    value={vitals.o2sat}
                                    onChange={(e) => setVitals({...vitals, o2sat: e.target.value})}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            tempRef.current?.focus();
                                        }
                                    }}
                                    disabled={isSigned}
                                    className={`w-full p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                        isAbnormalVital('o2sat', vitals.o2sat) ? 'text-red-600 font-bold' : ''
                                    }`}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">Temp (°F)</label>
                                <input
                                    ref={tempRef}
                                    type="number"
                                    step="0.1"
                                    placeholder="98.6"
                                    value={vitals.temp}
                                    onChange={(e) => setVitals({...vitals, temp: e.target.value})}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            weightRef.current?.focus();
                                        }
                                    }}
                                    disabled={isSigned}
                                    className={`w-full p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                        isAbnormalVital('temp', vitals.temp) ? 'text-red-600 font-bold' : ''
                                    }`}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">
                                    Weight
                                    {previousWeight && (
                                        <span className="ml-1 text-xs font-normal">
                                            {(() => {
                                                const change = getWeightChange();
                                                if (!change) return null;
                                                const isIncrease = parseFloat(change.lbs) > 0;
                                                return (
                                                    <span className={isIncrease ? 'text-red-600' : 'text-green-600'}>
                                                        ({isIncrease ? '+' : ''}{change.lbs} lbs)
                                                    </span>
                                                );
                                            })()}

                                        </span>
                                    )}
                                </label>
                                <div className="flex items-center gap-2">
                                    <input
                                        ref={weightRef}
                                        type="text"
                                        value={vitals.weight || ''}
                                        onChange={(e) => {
                                            const weight = e.target.value;
                                            const newVitals = {...vitals, weight};
                                            // Auto-calculate BMI when weight or height changes
                                            if (weight && vitals.height) {
                                                newVitals.bmi = calculateBMI(weight, vitals.weightUnit, vitals.height, vitals.heightUnit);
                                            } else {
                                                newVitals.bmi = '';
                                            }
                                            setVitals(newVitals);
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                heightRef.current?.focus();
                                            }
                                        }}
                                        disabled={isSigned}
                                        className={`flex-1 p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100 ${
                                            isAbnormalVital('weight', vitals.weight) ? 'text-red-600 font-bold' : ''
                                        }`}
                                    />
                                    <div className="flex border border-neutral-300 rounded overflow-hidden flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const newUnit = 'lbs';
                                                if (vitals.weight && vitals.weightUnit !== newUnit) {
                                                    const converted = convertWeight(vitals.weight, vitals.weightUnit, newUnit);
                                                    const newVitals = {...vitals, weightUnit: newUnit, weight: converted};
                                                    if (converted && vitals.height) {
                                                        newVitals.bmi = calculateBMI(converted, newUnit, vitals.height, vitals.heightUnit);
                                                    }
                                                    setVitals(newVitals);
                                                } else {
                                                    setVitals({...vitals, weightUnit: newUnit});
                                                }
                                            }}
                                            disabled={isSigned}
                                        className="flex-1 p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100"
                                    />
                                    <div className="flex border border-neutral-300 rounded overflow-hidden flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const newUnit = 'lbs';
                                                if (vitals.weight && vitals.weightUnit !== newUnit) {
                                                    const converted = convertWeight(vitals.weight, vitals.weightUnit, newUnit);
                                                    const newVitals = {...vitals, weightUnit: newUnit, weight: converted};
                                                    if (converted && vitals.height) {
                                                        newVitals.bmi = calculateBMI(converted, newUnit, vitals.height, vitals.heightUnit);
                                                    }
                                                    setVitals(newVitals);
                                                } else {
                                                    setVitals({...vitals, weightUnit: newUnit});
                                                }
                                            }}
                                            disabled={isSigned}
                                            className={`px-2 py-1 text-xs font-medium ${
                                                vitals.weightUnit === 'lbs' ? 'bg-primary-600 text-white' : 'bg-white text-neutral-700 hover:bg-primary-50'
                                            } disabled:bg-gray-100 disabled:text-gray-400`}
                                        >
                                            lbs
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const newUnit = 'kg';
                                                if (vitals.weight && vitals.weightUnit !== newUnit) {
                                                    const converted = convertWeight(vitals.weight, vitals.weightUnit, newUnit);
                                                    const newVitals = {...vitals, weightUnit: newUnit, weight: converted};
                                                    if (converted && vitals.height) {
                                                        newVitals.bmi = calculateBMI(converted, newUnit, vitals.height, vitals.heightUnit);
                                                    }
                                                    setVitals(newVitals);
                                                } else {
                                                    setVitals({...vitals, weightUnit: newUnit});
                                                }
                                            }}
                                            disabled={isSigned}
                                            className={`px-2 py-1 text-xs font-medium ${
                                                vitals.weightUnit === 'kg' ? 'bg-primary-600 text-white' : 'bg-white text-neutral-700 hover:bg-primary-50'
                                            } disabled:bg-gray-100 disabled:text-gray-400`}
                                        >
                                            kg
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">Height</label>
                                <div className="flex items-center gap-2">
                                    <input
                                        ref={heightRef}
                                        type="number"
                                        step="0.1"
                                        placeholder="70"
                                        value={vitals.height}
                                        onChange={(e) => {
                                            const height = e.target.value;
                                            const newVitals = {...vitals, height};
                                            // Auto-calculate BMI when weight or height changes
                                            if (height && vitals.weight) {
                                                newVitals.bmi = calculateBMI(vitals.weight, vitals.weightUnit, height, vitals.heightUnit);
                                            } else {
                                                newVitals.bmi = '';
                                            }
                                            setVitals(newVitals);
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                hpiRef.current?.focus();
                                            }
                                        }}
                                        disabled={isSigned}
                                        className="flex-1 p-1 text-xs border border-neutral-300 rounded bg-white focus:ring-1 focus:ring-primary-500 disabled:bg-gray-100"
                                    />
                                    <div className="flex border border-neutral-300 rounded overflow-hidden flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const newUnit = 'in';
                                                if (vitals.height && vitals.heightUnit !== newUnit) {
                                                    const converted = convertHeight(vitals.height, vitals.heightUnit, newUnit);
                                                    const newVitals = {...vitals, heightUnit: newUnit, height: converted};
                                                    if (converted && vitals.weight) {
                                                        newVitals.bmi = calculateBMI(vitals.weight, vitals.weightUnit, converted, newUnit);
                                                    }
                                                    setVitals(newVitals);
                                                } else {
                                                    setVitals({...vitals, heightUnit: newUnit});
                                                }
                                            }}
                                            disabled={isSigned}
                                            className={`px-2 py-1 text-xs font-medium ${
                                                vitals.heightUnit === 'in' ? 'bg-primary-600 text-white' : 'bg-white text-neutral-700 hover:bg-primary-50'
                                            } disabled:bg-gray-100 disabled:text-gray-400`}
                                        >
                                            in
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const newUnit = 'cm';
                                                if (vitals.height && vitals.heightUnit !== newUnit) {
                                                    const converted = convertHeight(vitals.height, vitals.heightUnit, newUnit);
                                                    const newVitals = {...vitals, heightUnit: newUnit, height: converted};
                                                    if (converted && vitals.weight) {
                                                        newVitals.bmi = calculateBMI(vitals.weight, vitals.weightUnit, converted, newUnit);
                                                    }
                                                    setVitals(newVitals);
                                                } else {
                                                    setVitals({...vitals, heightUnit: newUnit});
                                                }
                                            }}
                                            disabled={isSigned}
                                            className={`px-2 py-1 text-xs font-medium ${
                                                vitals.heightUnit === 'cm' ? 'bg-primary-600 text-white' : 'bg-white text-neutral-700 hover:bg-primary-50'
                                            } disabled:bg-gray-100 disabled:text-gray-400`}
                                        >
                                            cm
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-neutral-600 mb-1">BMI</label>
                                <input
                                    type="text"
                                    value={vitals.bmi || ''}
                                    readOnly
                                    placeholder="Auto"
                                    className={`w-full p-1 text-xs border border-neutral-300 rounded bg-gray-50 ${
                                        vitals.bmi && isAbnormalVital('bmi', vitals.bmi) ? 'text-red-600 font-bold' : ''
                                    }`}
                                />
                            </div>
                        </div>
                    </Section>

                    {/* Chief Complaint */}
                    <div className="mb-4">
                        <label className="block text-xs font-medium text-neutral-600 mb-1">Chief Complaint</label>
                        <input
                            type="text"
                            placeholder="Enter chief complaint..."
                            value={noteData.chiefComplaint || ''}
                            onChange={(e) => setNoteData({...noteData, chiefComplaint: e.target.value})}
                            disabled={isSigned}
                            className="w-full px-3 py-2 text-sm border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100"
                        />
                    </div>

                    {/* HPI */}
                    <Section title="History of Present Illness (HPI)" defaultOpen={true}>
                        {/* HPI Dot Phrase Search */}
                        <div className="mb-3">
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-ink-400" />
                                <input
                                    type="text"
                                    placeholder="Search HPI dot phrases... (e.g., .chest_pain)"
                                    value={hpiDotPhraseSearch}
                                    onChange={(e) => {
                                        setHpiDotPhraseSearch(e.target.value);
                                        setShowHpiDotPhraseResults(e.target.value.trim().length > 0);
                                    }}
                                    className="w-full pl-10 pr-4 py-2 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500"
                                />
                            </div>
                            {showHpiDotPhraseResults && filteredHpiDotPhrases.length > 0 && (
                                <div className="mt-2 border border-neutral-200 rounded bg-white shadow-lg max-h-60 overflow-y-auto">
                                    {filteredHpiDotPhrases.map((item) => (
                                        <button
                                            key={item.key}
                                            onClick={() => {
                                                const currentHpi = noteData.hpi || '';
                                                const newHpi = currentHpi ? `${currentHpi}\n\n${item.template}` : item.template;
                                                setNoteData({...noteData, hpi: newHpi});
                                                setHpiDotPhraseSearch('');
                                                setShowHpiDotPhraseResults(false);
                                            }}
                                            className="w-full text-left p-3 border-b border-neutral-100 hover:bg-primary-50 transition-colors"
                                        >
                                            <div className="font-medium text-ink-900 mb-1">{item.key}</div>
                                            <div className="text-xs text-ink-600 line-clamp-2">{item.template.substring(0, 150)}...</div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                        <textarea
                            ref={hpiRef}
                            value={noteData.hpi}
                            onChange={(e) => {
                                handleTextChange(e.target.value, 'hpi');
                                handleDotPhraseAutocomplete(e.target.value, 'hpi', hpiRef);
                            }}
                            onKeyDown={(e) => handleF2Key(e, hpiRef, 'hpi')}
                            onFocus={() => setActiveTextArea('hpi')}
                            disabled={isSigned}
                            rows={8}
                            className="w-full p-3 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 focus:border-neutral-500 disabled:bg-gray-100 font-serif text-sm leading-relaxed resize-none"
                            placeholder="Type .dotphrase to expand, or press F2 to find [] placeholders..."
                        />
                        <div className="mt-2 flex items-center space-x-2 text-xs text-ink-500">
                            <button
                                onClick={() => {
                                    setActiveTextArea('hpi');
                                    setShowDotPhraseModal(true);
                                }}
                                className="flex items-center space-x-1 text-blue-600 hover:text-blue-700"
                            >
                                <Zap className="w-3 h-3" />
                                <span>Dot Phrases (F2)</span>
                            </button>
                        </div>
                    </Section>

                    {/* ROS */}
                    <Section title="Review of Systems" defaultOpen={false}>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                            {Object.keys(noteData.ros).map(system => (
                                <label key={system} className="flex items-center space-x-2 cursor-pointer">
                                    {noteData.ros[system] ? (
                                        <CheckSquare className="w-4 h-4 text-blue-600" />
                                    ) : (
                                        <Square className="w-4 h-4 text-ink-400" />
                                    )}
                                    <span className="text-sm text-ink-700 capitalize">{system}</span>
                                    <input
                                        type="checkbox"
                                        checked={noteData.ros[system]}
                                        onChange={(e) => {
                                            const isChecked = e.target.checked;
                                            const systemName = system.charAt(0).toUpperCase() + system.slice(1);
                                            const findings = rosFindings[system] || '';
                                            // Update checkbox state
                                            const newRos = {...noteData.ros, [system]: isChecked};
                                            // Update textarea - add or remove findings
                                            let newRosNotes = noteData.rosNotes || '';
                                            const findingsLine = `${systemName}: ${findings}`;
                                            if (isChecked) {
                                                // Add findings if not already present
                                                if (!newRosNotes.includes(findingsLine)) {
                                                    newRosNotes = newRosNotes.trim() 
                                                        ? `${newRosNotes}
${findingsLine}`
                                                        : findingsLine;
                                                }
                                            } else {
                                                // Remove findings line
                                                newRosNotes = newRosNotes
                                                    .split('\n')
                                                    .filter(line => !line.trim().startsWith(systemName + ':'))
                                                    .join('\n')
                                            }
                                            setNoteData({
                                                ...noteData,
                                                ros: newRos,
                                                rosNotes: newRosNotes
                                            });
                                        }}
                                        disabled={isSigned}
                                        className="hidden"
                                    />
                                </label>
                            ))}
                        </div>
                        <textarea
                            value={noteData.rosNotes}
                            onChange={(e) => setNoteData({...noteData, rosNotes: e.target.value})}
                            disabled={isSigned}
                            rows={3}
                            className="w-full p-3 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 font-serif text-sm"
                            placeholder="Additional ROS notes..."
                        />
                        <button
                            onClick={() => {
                                const allNormal = Object.values(noteData.ros).every(v => v);
                                const rosText = allNormal 
                                    ? 'Review of Systems: All systems reviewed and negative except as noted above.'
                                    : 'Review of Systems: Negative except as noted above.';
                                setNoteData({...noteData, rosNotes: rosText});
                            }}
                            disabled={isSigned}
                            className="mt-2 px-3 py-1 text-xs bg-primary-100 hover:bg-primary-200 text-ink-700 rounded disabled:opacity-50"
                        >
                            Pre-fill Normal ROS
                        </button>
                    </Section>

                    {/* Physical Exam */}
                    <Section title="Physical Examination" defaultOpen={true}>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                            {Object.keys(noteData.pe).map(system => (
                                <label key={system} className="flex items-center space-x-2 cursor-pointer">
                                    {noteData.pe[system] ? (
                                        <CheckSquare className="w-4 h-4 text-blue-600" />
                                    ) : (
                                        <Square className="w-4 h-4 text-ink-400" />
                                    )}
                                    <span className="text-sm text-ink-700 capitalize">{system.replace(/([A-Z])/g, ' $1').trim()}</span>
                                    <input
                                        type="checkbox"
                                        checked={noteData.pe[system]}
                                        onChange={(e) => {
                                            const isChecked = e.target.checked;
                                            const systemName = system.replace(/([A-Z])/g, ' $1').trim()
                                                .split(' ')
                                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                                .join(' ');
                                            const findings = peFindings[system] || '';
                                            // Update checkbox state
                                            const newPe = {...noteData.pe, [system]: isChecked};
                                            // Update textarea - add or remove findings
                                            let newPeNotes = noteData.peNotes || '';
                                            const findingsLine = `${systemName}: ${findings}`;
                                            if (isChecked) {
                                                // Add findings if not already present
                                                if (!newPeNotes.includes(findingsLine)) {
                                                    newPeNotes = newPeNotes.trim() 
                                                        ? `${newPeNotes}
${findingsLine}`
                                                        : findingsLine;
                                                }
                                            } else {
                                                newPeNotes = newPeNotes
                                                    .split('\n')
                                                    .filter(line => !line.trim().startsWith(systemName + ':'))
                                                    .join('\n')
                                                    .trim();
                                            }
                                            setNoteData({
                                                ...noteData,
                                                pe: newPe,
                                                peNotes: newPeNotes
                                            });
                                        }}

                                        disabled={isSigned}
                                        className="hidden"
                                    />
                                </label>
                            ))}
                        </div>
                        <textarea
                            value={noteData.peNotes}
                            onChange={(e) => setNoteData({...noteData, peNotes: e.target.value})}
                            disabled={isSigned}
                            rows={4}
                            className="w-full p-3 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 font-serif text-sm"
                            placeholder="Physical exam findings..."
                        />
                        <button
                            onClick={() => {
                                const peText = 'Physical Examination: General appearance: Well-appearing. Vital signs stable. Examination unremarkable except as noted above.';
                                setNoteData({...noteData, peNotes: peText});
                            }}
                            disabled={isSigned}
                            className="mt-2 px-3 py-1 text-xs bg-primary-100 hover:bg-primary-200 text-ink-700 rounded disabled:opacity-50"
                        >
                            Pre-fill Normal PE
                        </button>
                    </Section>

                    {/* Assessment */}
                    <Section title="Assessment" defaultOpen={true}>
                        <div className="mb-3 flex items-center space-x-2">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-ink-400" />
                                <input
                                    type="text"
                                    placeholder="Search ICD-10 codes..."
                                    value={icd10Search}
                                    onChange={(e) => {
                                        setIcd10Search(e.target.value);
                                        setShowIcd10Search(e.target.value.trim().length > 0);
                                    }}
                                    className="w-full pl-10 pr-4 py-2 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500"
                                />
                            </div>
                            <label className="flex items-center space-x-2 text-xs text-ink-600">
                                <input
                                    type="checkbox"
                                    checked={icd10AddToProblem}
                                    onChange={(e) => setIcd10AddToProblem(e.target.checked)}
                                    className="rounded"
                                />
                                <span>Add to Problem List</span>
                            </label>
                        </div>
                        {showIcd10Search && icd10Results.length > 0 && (
                            <div className="mb-3 border border-neutral-200 rounded bg-white shadow-lg max-h-60 overflow-y-auto">
                                {icd10Results.map((code) => (
                                    <button
                                        key={code.code}
                                        onClick={() => handleAddICD10(code)}
                                        className="w-full text-left p-3 border-b border-neutral-100 hover:bg-primary-50 transition-colors"
                                    >
                                        <div className="font-medium text-ink-900">{code.code}</div>
                                        <div className="text-sm text-ink-600">{code.description}</div>
                                    </button>
                                ))}
                            </div>
                        )}
                        <textarea
                            ref={assessmentRef}
                            value={noteData.assessment}
                            onChange={(e) => {
                                handleTextChange(e.target.value, 'assessment');
                                handleDotPhraseAutocomplete(e.target.value, 'assessment', assessmentRef);
                            }}
                            onKeyDown={(e) => handleF2Key(e, assessmentRef, 'assessment')}
                            onFocus={() => setActiveTextArea('assessment')}
                            disabled={isSigned}
                            rows={6}
                            className="w-full p-3 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 font-serif text-sm leading-relaxed resize-none"
                            placeholder="Enter diagnoses..."
                        />
                    </Section>

                    {/* Plan */}
                    <Section title="Plan" defaultOpen={true}>
                        <textarea
                            ref={planRef}
                            value={noteData.plan}
                            onChange={(e) => {
                                handleTextChange(e.target.value, 'plan');
                                handleDotPhraseAutocomplete(e.target.value, 'plan', planRef);
                            }}
                            onKeyDown={(e) => handleF2Key(e, planRef, 'plan')}
                            onFocus={() => setActiveTextArea('plan')}
                            disabled={isSigned}
                            rows={8}
                            className="w-full p-3 border border-neutral-300 rounded bg-white focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 font-serif text-sm leading-relaxed resize-none"
                            placeholder="Enter plan, orders, medications..."
                        />
                        {!isSigned && (
                            <div className="mt-3 flex space-x-2">
                                <button
                                    onClick={() => setShowOrderModal(true)}
                                    className="px-3 py-1.5 text-sm bg-primary-100 hover:bg-primary-200 text-ink-700 rounded border border-neutral-300"
                                >
                                    Add Order
                                </button>
                                <button
                                    onClick={() => setShowPrescriptionModal(true)}
                                    className="px-3 py-1.5 text-sm bg-primary-100 hover:bg-primary-200 text-ink-700 rounded border border-neutral-300"
                                >
                                    e-Prescribe
                                </button>
                                <button
                                    onClick={() => setShowReferralModal(true)}
                                    className="px-3 py-1.5 text-sm bg-primary-100 hover:bg-primary-200 text-ink-700 rounded border border-neutral-300"
                                >
                                    Send Referral
                                </button>
                            </div>
                        )}
                    </Section>
                </div>
            </div>

            {/* Modals */}
            <OrderModal 
                isOpen={showOrderModal} 
                onClose={() => setShowOrderModal(false)} 
                onSuccess={(message) => {
                    showToast(message);
                    const newPlanLine = noteData.plan ? `\n${message}` : message;
                    setNoteData({ ...noteData, plan: noteData.plan + newPlanLine });
                }}
            />
            <PrescriptionModal
                isOpen={showPrescriptionModal}
                onClose={() => setShowPrescriptionModal(false)}
                onSuccess={(message) => {
                    showToast(message);
                    const newPlanLine = noteData.plan ? `\n${message}` : message;
                    setNoteData({ ...noteData, plan: noteData.plan + newPlanLine });
                }}
            />
            <ReferralModal
                isOpen={showReferralModal}
                onClose={() => setShowReferralModal(false)}
                onSuccess={(message) => {
                    showToast(message);
                    const newPlanLine = noteData.plan ? `\n${message}` : message;
                    setNoteData({ ...noteData, plan: noteData.plan + newPlanLine });
                }}
            />
            {showPrintModal && (
                <VisitPrint
                    visitId={currentVisitId || urlVisitId}
                    patientId={id}
                    onClose={() => setShowPrintModal(false)}
                />
            )}
            <PatientHistoryPanel
                patientId={id}
                isOpen={showHistoryPanel}
                onClose={() => setShowHistoryPanel(false)}
            />
            <PatientHub
                patientId={id}
                isOpen={showPatientHub}
                onClose={() => setShowPatientHub(false)}
            />
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {/* Dot Phrase Modal */}
            {showDotPhraseModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => {
                    setShowDotPhraseModal(false);
                    setDotPhraseSearch('');
                    setActiveTextArea(null);
                }}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className="p-4 border-b border-neutral-200 flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-ink-900 flex items-center space-x-2">
                                <Zap className="w-5 h-5 text-primary-600" />
                                <span>Dot Phrases</span>
                                {activeTextArea && (
                                    <span className="text-sm font-normal text-ink-500">
                                        (Inserting into {activeTextArea.toUpperCase()})
                                    </span>
                                )}
                            </h3>
                            <button
                                onClick={() => {
                                    setShowDotPhraseModal(false);
                                    setDotPhraseSearch('');
                                    setActiveTextArea(null);
                                }}
                                className="p-1 hover:bg-primary-100 rounded"
                            >
                                <X className="w-5 h-5 text-ink-500" />
                            </button>
                        </div>
                        <div className="p-4 border-b border-neutral-200">
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-ink-400" />
                                <input
                                    type="text"
                                    value={dotPhraseSearch}
                                    onChange={(e) => setDotPhraseSearch(e.target.value)}
                                    placeholder="Search dot phrases... (Press F2 to open, Esc to close)"
                                    className="w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-md focus:ring-2 focus:ring-primary-400 focus:border-transparent"
                                    autoFocus
                                />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            {filteredDotPhrases.length === 0 ? (
                                <div className="text-center text-ink-500 py-8">
                                    {dotPhraseSearch.trim() ? `No dot phrases found matching "${dotPhraseSearch}"` : 'Start typing to search dot phrases...'}
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {filteredDotPhrases.map((item, index) => {
                                        const template = hpiDotPhrases[item.key];
                                        return (
                                            <button
                                                key={`${item.key}-${index}`}
                                                onClick={() => handleDotPhrase(item.key)}
                                                className="w-full text-left p-3 border border-neutral-200 rounded-md hover:bg-primary-50 hover:border-neutral-300 transition-colors"
                                            >
                                                <div className="font-medium text-ink-900 mb-1">{item.key}</div>
                                                <div className="text-sm text-ink-600 space-y-1 max-h-24 overflow-hidden">
                                                    {template.split(/[.\n]/).filter(s => s.trim()).slice(0, 4).map((sentence, idx) => (
                                                        <div key={idx} className="flex items-start">
                                                            <span className="text-ink-400 mr-2">•</span>
                                                            <span className="flex-1">{sentence.trim()}</span>
                                                        </div>
                                                    ))}
                                                    {template.split(/[.\n]/).filter(s => s.trim()).length > 4 && (
                                                        <div className="text-ink-400 italic">...</div>
                                                    )}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </div>
    </div>
    ));
};

export default VisitNote;
