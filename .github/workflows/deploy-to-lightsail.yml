name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Save the SSH key (preserve line endings)
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          
          # Verify key format
          if ! head -1 ~/.ssh/lightsail_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "‚ùå Error: SSH key doesn't start with BEGIN marker"
            echo "First line of key: $(head -1 ~/.ssh/lightsail_key)"
            exit 1
          fi
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Test SSH connection with verbose output for debugging
          echo "Testing SSH connection to ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}..."
          ssh -v -i ~/.ssh/lightsail_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} \
              "echo 'SSH connection successful'" 2>&1 || {
            echo "‚ùå SSH connection test failed!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify LIGHTSAIL_SSH_KEY secret contains the full private key including BEGIN/END lines"
            echo "2. Verify LIGHTSAIL_HOST is correct: ${{ secrets.LIGHTSAIL_HOST }}"
            echo "3. Verify LIGHTSAIL_USER is correct: ${{ secrets.LIGHTSAIL_USER }}"
            echo "4. Check that the SSH key matches the public key on the server"
            exit 1
          }
          echo "‚úÖ SSH connection successful!"
      
      - name: Deploy to Lightsail
        env:
          DEPLOY_DIR: /home/ubuntu/emr
        run: |
          ssh -i ~/.ssh/lightsail_key -o StrictHostKeyChecking=no ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'EOF'
            set -e
            
            echo "üìÇ Navigating to app directory..."
            # Try multiple possible directory locations
            if [ -d "$DEPLOY_DIR" ]; then
              cd "$DEPLOY_DIR"
              echo "‚úÖ Found app directory: $DEPLOY_DIR"
            elif [ -d "/home/ubuntu/emr" ]; then
              cd /home/ubuntu/emr
              echo "‚úÖ Found app directory: /home/ubuntu/emr"
            elif [ -d "/home/ubuntu/app" ]; then
              cd /home/ubuntu/app
              echo "‚úÖ Found app directory: /home/ubuntu/app"
            else
              echo "‚ùå App directory not found!"
              echo "Searched in: $DEPLOY_DIR, /home/ubuntu/emr, /home/ubuntu/app"
              echo "Current directory: $(pwd)"
              echo "Available directories:"
              ls -la /home/ubuntu/ | head -10
              exit 1
            fi
            
            echo "‚¨áÔ∏è  Pulling latest changes from GitHub..."
            # Check if this is a git repository
            if [ ! -d .git ]; then
              echo "‚ùå Not a git repository! Initializing..."
              git init
              git remote add origin https://github.com/Lynqcloudpay/PageMD.git || git remote set-url origin https://github.com/Lynqcloudpay/PageMD.git
              git fetch origin
              git checkout -b main origin/main || git checkout -b main
            fi
            
            # Ensure we're on main branch and pull latest
            git fetch origin main || git fetch origin || { echo "‚ö†Ô∏è  Git fetch failed, trying to continue..."; }
            git checkout main 2>/dev/null || git checkout -b main 2>/dev/null || true
            git pull origin main || git pull || { 
              echo "‚ö†Ô∏è  Git pull failed, but continuing with existing code..."
              echo "This may happen if the directory was manually set up."
            }
            
            # Check if deploy directory exists
            if [ ! -d "deploy" ]; then
              echo "‚ùå deploy/ directory not found!"
              echo "Current directory: $(pwd)"
              echo "Available files:"
              ls -la | head -10
              exit 1
            fi
            
            cd deploy
            echo "‚úÖ In deploy directory: $(pwd)"
            
            echo "‚öôÔ∏è  Checking environment variables..."
            # Ensure .env.prod has correct domain if it was copied from old example
            if [ -f .env.prod ]; then
              if grep -q "yourdomain.com" .env.prod; then
                echo "üìù Updating domain in existing .env.prod..."
                sed -i 's/yourdomain.com/bemypcp.com/g' .env.prod
              fi
            else
              echo "‚ö†Ô∏è  .env.prod not found! Copying from example..."
              cp env.prod.example .env.prod
              echo "‚ö†Ô∏è  Please configure .env.prod manually on the server!"
            fi
            
            echo "üîí Ensuring DB SSL certificates exist..."
            # Fix for existing databases where init-db.sh won't run
            docker run --rm -v emr_postgres_data:/var/lib/postgresql/data alpine sh -c "
              if [ ! -f /var/lib/postgresql/data/server.key ]; then 
                echo 'Generating missing SSL certs...'; 
                apk add --no-cache openssl; 
                openssl req -new -x509 -days 365 -nodes -text -out /var/lib/postgresql/data/server.crt -keyout /var/lib/postgresql/data/server.key -subj '/CN=postgres'; 
                chmod 600 /var/lib/postgresql/data/server.key; 
                chmod 644 /var/lib/postgresql/data/server.crt; 
                cp /var/lib/postgresql/data/server.crt /var/lib/postgresql/data/ca.crt; 
                chown 70:70 /var/lib/postgresql/data/server.*; 
                echo 'Certs generated successfully'; 
              else 
                echo 'Certs already exist'; 
              fi" || echo "‚ö†Ô∏è  Certificate check skipped (volume may not exist yet)"
            
            echo "üîÑ Rebuilding and restarting services..."
            # Rebuild api and web containers
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate
            
            echo "‚úÖ Deployment complete!"
            echo "üåç Checking site status..."
            sleep 5
            curl -I https://bemypcp.com || echo "‚ö†Ô∏è  Site check failed, but deployment completed"
            
            echo "üìä Container status:"
            docker compose -f docker-compose.prod.yml ps
          EOF
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment workflow completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.LIGHTSAIL_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåç Website: https://bemypcp.com" >> $GITHUB_STEP_SUMMARY

